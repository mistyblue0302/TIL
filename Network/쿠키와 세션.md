## 쿠키와 세션

### 쿠키와 세션을 사용하는 이유

HTTP 프로토콜은 비연결지향(Connectionless) & 무상태(Stateless)라는 특징을 가진다. 통신 연결을 유지하지 않기 때문에 리소스 낭비가 줄어들지만 통신할 때마다 인증해야하는 문제가 있다. 이러한 HTTP의 단점을 보완하기 위해 쿠키와 세션을 사용한다.

## 쿠키

- 쿠키는 클라이언트 로컬(브라우저)에 저장되는 키와 값이 들어있는 작은 데이터 파일로 클라이언트의 상태 정보를 로컬에 저장했다가 요청할 때 참조된다.
  - 쿠키는 두 가지 유형이 있다.
  - 세션 쿠키 : 만료 시간이 없으며, **메모리** 상에만 존재하기 때문에 유저가 브라우저를 닫을 경우 지워진다.
  - 영구 쿠키 : **디스크**에 저장된다. 쿠키의 만료 시간이 설정되며, 그 시간까지 클라이언트의 디스크에 저장된다.
- 쿠키는 서버측에서 만료 날짜와 시간을 지정하여 정해진 시간동안 상태정보를 유지할 수 있다.
- 쿠키 프로세스
  - 브라우저에서 웹 페이지 접속
  - 서버는 쿠키를 생성하여 전달(Response Header의 set-Cookie)
  - 클라이언트는 쿠키를 클라이언트 로컬(하드)에 저장
  - 클라이언트가 재요청 시, 웹 페이지 요청과 함께 쿠키값도 전송
  - 서버는 쿠키로 사용자를 식별하고 요청을 처리
  - max-age(상대 시간), expires(절대 시간) 옵션을 통해 쿠키 소멸 시간을 지정할 수 있다.
- 쿠키 사용용도 : 자동로그인, 아이디 저장, 7일간 보지 않기, 장바구니 

### 쿠키는 어떻게 만들까?

클라이언트가 서버에 요청하면, 서버가 응답할 때 쿠키에 저장하고자 하는 정보를 header의 Set-Cookie로 함께 전달한다.

```
Set-Cookie : <cookie-name>=<cookie-value>
```

클라이언트는 서버로 전송하는 모든 요청에, 현재 브라우저에 저장된 모든 쿠키를 header의 Cookie로 전달한다.

```
Cookie: <cookie-name>=<cookie-value>
```

서버가 쿠키와 함께 아래와 같은 응답을 클라이언트에게 전달했다고 하면,

```
HTTP/1.0 200 OK
Content-type: text/html
Set-Cookie: cookie=choco
Set-Cookie: cookie2=strawberry
```

이후로 해당 클라이언트는 저장된 쿠키를 매번 헤더에 포함하여 요청을 보내게 된다.

```
GET /sample_page.html HTTP/1.1
Host: www.github.com/dilmah0203
Cookie: cookie=choco; cookie2=strawberry
```

쿠키 소멸 시간은 쿠키를 생성할 때 Expires 또는 Max-Age 옵션을 추가하여 정할 수 있다.

```
Set-Cookie: cookie=choco; Max-Age=3600;
```

```
Set-Cookie: cookie=choco; Expires=Wed, 26 Oct 2023 03:14:00 GMT;
```

## 세션

- 세션은 웹 브라우저가 아닌 서버에 클라이언트의 상태 정보를 저장한다. 클라이언트가 요청을 보내면 서버가 클라이언트에게 유일한 ID(session_id)를 부여한다.
- 세션 프로세스
  - 클라이언트가 서버에 요청을 보낸다.
  - 서버에서는 session_id를 생성하고 쿠키를 통해 저장(JESSIONID)한 다음, 클라이언트에 전달(Response Header의 set-Cookie)하여 응답한다. (session_id가 있는지 없는지 체크를 해서 없으면 신규 생성)
  - 클라이언트는 전달받은 session_id값을 매 요청마다 헤더 쿠키에 넣어 저장
  - 서버는 session_id를 통해 사용자를 식별
- 세션 사용용도 : 로그인 정보 유지

### 세션은 어떻게 만들까?

서버는 클라이언트에 로그인 요청에 대한 응답을 작성할 때, 인증 정보는 서버에 저장하고 사용자의 식별자인 JSESSIONID(session_id)를 쿠키에 담아 전송한다. 이후 클라이언트는 요청을 보낼 때마다 JSESSIONID 쿠키를 함께 보내고, 서버는 이 ID의 유효성을 판별하여 클라이언트를 식별한다.

```
HTTP/1.1 200
Set-Cookie: JSESSIONID=FDB5E30BF20035E8AAFC187383623C;
```

웹 브라우저에 쿠키를 저장하여 HTTP로 전송하는 방식 대신, 서버에 사용자의 인증 정보를 저장하여 session_id를 쿠키에 담아 전송하는 세션 방식이 보안상 훨씬 안전한 방법이라 할 수 있다.

세션 유효 시간은 yml 설정 파일과 session.setMaxInactiveInterval( ) 메소드를 사용하여 정할 수 있다.

```
server:
  servlet:
    session:
      timeout: 1800
```

```
session.setMaxInactiveInterval(1800); //1800초, 특정 세션 단위로 시간 설정
```

## 쿠키와 세션의 차이
  
- 저장위치
  - 쿠키는 브라우저에 메모리 또는 파일로 저장하고, 세션은 서버 메모리에 저장된다.
- 라이프사이클
  - 쿠키는 저장할 때 expires 속성을 통해 삭제될 시간을 지정가능한 반면, 세션은 클라이언트가 로그아웃 하거나 설정 시간동안 반응이 없으면 무효화되어 정확한 시점을 알 수 없다.
- 속도
  - 쿠키는 파일에서 읽기 때문에 속도가 빠르고 세션은 요청마다 서버에서 처리해야 되기 때문에 느리다.
- 보안
  - 클라이언트의 웹 브라우저에 쿠키를 저장해놓고, 매 요청마다 헤더에 쿠키를 넣어 전달하는 방식을 사용하여 인증을 구현할 경우, 쿠키가 유출되거나 조작될 수 있어 보안에 취약하다.
  - 자바스크립트로 쿠키를 가로채려고 할 때 쿠키 생성 코드 Set-Cookie에 httpOnly를 추가함으로써 XSS 공격이 차단된다. 또한 HTTPS로 전송되어야 할 정보가 HTTP를 통해 유출되는 경우 Set-Cookie에 secure 접미사를 사용할 수 있다.
  - 반대로 세션은 클라이언트 정보 자체가 서버에 저장되어 있어서 비교적 안전하다.
 
```
Set-Cookie: cookie=choco; secure; httpOnly;
```

**왜 둘 다 사용할까?**
세션은 쿠키에 비해 보안이 높은 편이나 서버의 자원에 한계가 있고 속도저하가 올 수 있기 때문에 쿠키와 세션을 적절히 사용하여 서버 자원의 낭비를 방지하고 웹사이트의 속도를 높일 수 있다.
